<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <!-- ADDING p5js  LIBRARY-->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
  <script src="sketch.js"></script>

  <title>Selfie App</title>
</head>

<body>

  <h1>HELLO KOTAKPAS</h1>
  <a href="./logs/index.html">go to all</a>
  <div id="position_wrapper">your position is:
    lat: <span id="lat"></span>,
    long: <span id="long"></span>.
  </div>
  <input type="text" name="" id="name_input" placeholder="SAY THE NAME">
  <button id="send_btn">SUBMIT</button>
  <div id="Mymap"></div>

  <script>
    // p5 setup:
    function setup() {

      noCanvas();
      const video = createCapture(VIDEO);
      video.size(160, 120);

      const latitudeEl = document.getElementById("lat");
      const longitudeEl = document.getElementById("long");
      const sendBtnEl = document.getElementById("send_btn");
      const nameInputEl = document.getElementById("name_input");

      if ("geolocation" in navigator) {
        console.log("GEOLOCATION IS AVAILABLE");

        navigator.geolocation.getCurrentPosition((position) => {

          const myLat = position.coords.latitude;
          latitudeEl.innerText = myLat;
          const myLong = position.coords.longitude;
          longitudeEl.innerText = myLong;

          const dataExchangeSequence = async () => {

            if (nameInputEl.value) {
              const myName = nameInputEl.value

              video.loadPixels();
              const image64 = video.canvas.toDataURL();

              const data = { myLat, myLong, myName, image64 };
              nameInputEl.value = "";
              //  hey, I want:
              //  1 this data to be sent as JSON
              //  2 I tell you this is JSON
              //  2 I want to post it to '/api'
              const options = {
                method: "POST",
                body: JSON.stringify(data),
                headers: { "Content-Type": "application/json" },
              };
              //OMG here i make a request to a server and then i log response
              //So this is what it means
              const response = await fetch("/api", options);
              console.log("COORDINATES SENT TO SERVER, AWAIT RESPONSE");
              const newData = await response.json();
              console.log("RESPONSE FROM SERVER: ", newData);
            } else {
              nameInputEl.placeholder = "PLEASE ENTER NAME";
            }
          };

          sendBtnEl.addEventListener("click", dataExchangeSequence);

        });
      } else {
        console.log("ERROR GEOLOCATION IS NOT AVAILABLE");
        latitudeEl.innerText = "*******";
        longitudeEl.innerText = "*******";
        sendBtnEl.innerText = "GEO DATA NOT AVAILABLE";
      }
    }

  </script>

</body>

</html>